/**
 * Copyright (C) 2013-2014 EaseMob Technologies. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.easemob.chatuidemo.activity;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.ListView;
import android.widget.Toast;

import com.easemob.chat.EMChatManager;
import com.easemob.chatuidemo.R;
import com.easemob.widget.EMChatWidget;

/**
 * 聊天页面
 * 
 */
public class ChatActivity extends Activity implements EMChatWidget.EMChatWidgetUser {
	private static final String TAG = "ChatActivity";
	private static final int REQUEST_CODE_EMPTY_HISTORY = 2;
	public static final int REQUEST_CODE_CONTEXT_MENU = 3;
	private static final int REQUEST_CODE_MAP = 4;
	public static final int REQUEST_CODE_TEXT = 5;
	public static final int REQUEST_CODE_VOICE = 6;
	public static final int REQUEST_CODE_PICTURE = 7;
	public static final int REQUEST_CODE_LOCATION = 8;
	public static final int REQUEST_CODE_NET_DISK = 9;
	public static final int REQUEST_CODE_FILE = 10;
	public static final int REQUEST_CODE_COPY_AND_PASTE = 11;
	public static final int REQUEST_CODE_PICK_VIDEO = 12;
	public static final int REQUEST_CODE_DOWNLOAD_VIDEO = 13;
	public static final int REQUEST_CODE_VIDEO = 14;
	public static final int REQUEST_CODE_DOWNLOAD_VOICE = 15;
	public static final int REQUEST_CODE_SELECT_USER_CARD = 16;
	public static final int REQUEST_CODE_SEND_USER_CARD = 17;
	public static final int REQUEST_CODE_CAMERA = 18;
	public static final int REQUEST_CODE_LOCAL = 19;
	public static final int REQUEST_CODE_CLICK_DESTORY_IMG = 20;
	public static final int REQUEST_CODE_GROUP_DETAIL = 21;
	public static final int REQUEST_CODE_SELECT_VIDEO = 23;
	public static final int REQUEST_CODE_SELECT_FILE = 24;
	public static final int REQUEST_CODE_ADD_TO_BLACKLIST = 25;

	public static final int RESULT_CODE_COPY = 1;
	public static final int RESULT_CODE_DELETE = 2;
	public static final int RESULT_CODE_FORWARD = 3;
	public static final int RESULT_CODE_OPEN = 4;
	public static final int RESULT_CODE_DWONLOAD = 5;
	public static final int RESULT_CODE_TO_CLOUD = 6;
	public static final int RESULT_CODE_EXIT_GROUP = 7;

	public static final int CHATTYPE_SINGLE = 1;
	public static final int CHATTYPE_GROUP = 2;

	public static final String COPY_IMAGE = "EASEMOBIMG";
	EMChatWidget chatWidget;
	public static ChatActivity activityInstance;
	// TODO, EMWidget
	public String playMsgId = "";

	@Override
	public void onCreate(Bundle bundle) {
		super.onCreate(bundle);
		setContentView(R.layout.em_activity_chat);
		chatWidget = (EMChatWidget) findViewById(R.id.chat);
		
		int chatType = getIntent().getIntExtra("chatType", CHATTYPE_SINGLE);
		final String username;
		if (chatType == CHATTYPE_SINGLE) {
			username = getIntent().getStringExtra("userId");
		} else {
			username = getIntent().getStringExtra("groupId");
		}
		chatWidget.setUpView(chatType, username);
		chatWidget.setUser(this);
		
		chatWidget.setVoiceCallToolBoxClick(new View.OnClickListener() {
			@Override
			public void onClick(View v) {
				String st1 = getResources().getString(R.string.not_connect_to_server);
				if (!EMChatManager.getInstance().isConnected())
					Toast.makeText(ChatActivity.this, st1, Toast.LENGTH_SHORT).show();
				else
					startActivity(new Intent(ChatActivity.this, VoiceCallActivity.class)
							.putExtra("username", username).putExtra(
									"isComingCall", false));
			}
		});
		
		
		chatWidget.setVideoCallToolBoxClick(new View.OnClickListener() {
			@Override
			public void onClick(View v) {
				String st1 = getResources().getString(R.string.not_connect_to_server);
				if (!EMChatManager.getInstance().isConnected())
					Toast.makeText(ChatActivity.this, st1, Toast.LENGTH_SHORT).show();
				else
					startActivity(new Intent(ChatActivity.this, VideoCallActivity.class).putExtra(
							"username", username).putExtra("isComingCall", false));
			}
		});
		
		activityInstance = this;
	}
	
	public void onActivityResult(int requestCode, int resultCode, Intent data) {
		chatWidget.onActivityResult(requestCode, resultCode, data);
		return;
	}

	@Override
	public void onDestroy() {
		ChatActivity.activityInstance = null;
		super.onDestroy();
	}

	public String getToChatUsername() {
		return "user0";
	}
	
	public ListView getListView() {
		return null;
	}
	
	public void onGroupDetail(String groupId) {
		// TODO, EMWidget
		startActivityForResult((new Intent(this, GroupDetailsActivity.class).putExtra("groupId", groupId)),
				REQUEST_CODE_GROUP_DETAIL);
	}
	
	public void onVoiceCall(String toChatUsername) {
		String st1 = getResources().getString(R.string.not_connect_to_server);
		if (!EMChatManager.getInstance().isConnected())
			Toast.makeText(this, st1, Toast.LENGTH_SHORT).show();
		else
			startActivity(new Intent(ChatActivity.this, VoiceCallActivity.class)
					.putExtra("username", toChatUsername).putExtra(
							"isComingCall", false));
	}

	public void onVideoCall(String toChatUsername) {
		String st1 = getResources().getString(R.string.not_connect_to_server);
		if (!EMChatManager.getInstance().isConnected())
			Toast.makeText(this, st1, Toast.LENGTH_SHORT).show();
		else
			startActivity(new Intent(this, VideoCallActivity.class).putExtra(
					"username", toChatUsername).putExtra("isComingCall", false));
	}
	
	@Override
	public void onPause() {
		chatWidget.onPause();
		super.onPause();
	}
	
	@Override
	public void onResume() {
		super.onResume();
		chatWidget.refresh();
	}
}
